<UserControl x:Class="WMS.Client.Views.FinancialView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             mc:Ignorable="d" d:DesignHeight="1000" d:DesignWidth="900">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <Style x:Key="CenterText" TargetType="TextBlock">
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <DataTemplate x:Key="ExpandButtonTemplate">
            <ToggleButton Style="{StaticResource MaterialDesignFlatPrimaryToggleButton}"
                          IsChecked="{Binding IsExpanded, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          Width="30" Height="30"
                          Cursor="Hand"
                          ToolTip="点击展开/折叠详情">
                <materialDesign:PackIcon Kind="ChevronRight" Width="20" Height="20">
                    <materialDesign:PackIcon.Style>
                        <Style TargetType="materialDesign:PackIcon" BasedOn="{StaticResource {x:Type materialDesign:PackIcon}}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                                    <Setter Property="Kind" Value="ChevronDown"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </materialDesign:PackIcon.Style>
                </materialDesign:PackIcon>
            </ToggleButton>
        </DataTemplate>

        <DataTemplate x:Key="FinancialDetailsTemplate">
            <Border Background="#F9F9F9" Padding="20,10,10,10" BorderBrush="#E0E0E0" BorderThickness="0,1,0,1">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <materialDesign:PackIcon Kind="SubdirectoryArrowRight" Margin="0,0,5,0" VerticalAlignment="Center" Foreground="Gray"/>
                        <TextBlock Text="该时段单品销售明细：" FontWeight="Bold" Foreground="Gray" VerticalAlignment="Center"/>
                    </StackPanel>

                    <DataGrid ItemsSource="{Binding Details}" 
                              PreviewMouseWheel="InnerDataGrid_PreviewMouseWheel"
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False" 
                              IsReadOnly="True"
                              HeadersVisibility="Column" 
                              SelectionMode="Single"
                              Background="White" 
                              BorderThickness="1" 
                              BorderBrush="#EEEEEE"
                              VerticalScrollBarVisibility="Disabled"
                              Focusable="False"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="8">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="产品名称" Binding="{Binding ProductName}" Width="200" FontWeight="Medium"/>
                            <DataGridTextColumn Header="收入" Binding="{Binding Revenue, StringFormat=C2}" Width="100" Foreground="#4CAF50"/>
                            <DataGridTextColumn Header="成本" Binding="{Binding Cost, StringFormat=C2}" Width="100" Foreground="#F44336"/>
                            <DataGridTextColumn Header="销售利润" Binding="{Binding SalesProfit, StringFormat=C2}" Width="100" Foreground="#FF9800"/>
                            <DataGridTextColumn Header="退款" Binding="{Binding Refund, StringFormat=C2}" Width="80"/>
                            <DataGridTextColumn Header="贡献毛利" Binding="{Binding Profit, StringFormat=C2}" Width="100" FontWeight="Bold" Foreground="#3F51B5"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">

        <StackPanel Margin="0,0,10,20">

            <TextBlock Text="财务收支概览" FontSize="24" FontWeight="Bold" Margin="0,0,0,10"/>

            <Grid Margin="0,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <materialDesign:Card Grid.Column="0" Margin="0,0,10,0" Padding="15" UniformCornerRadius="8" Background="#4CAF50">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <materialDesign:PackIcon Kind="CashMultiple" Width="24" Height="24" Foreground="White" VerticalAlignment="Center"/>
                            <TextBlock Text="销售总收入" Foreground="White" FontSize="16" FontWeight="SemiBold" Margin="10,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <TextBlock Text="{Binding TotalRevenue, StringFormat=C2}" Foreground="White" FontSize="24" FontWeight="Bold" HorizontalAlignment="Right"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Column="1" Margin="10,0,10,0" Padding="15" UniformCornerRadius="8" Background="#F44336">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <materialDesign:PackIcon Kind="CartOutline" Width="24" Height="24" Foreground="White" VerticalAlignment="Center"/>
                            <TextBlock Text="采购总成本" Foreground="White" FontSize="16" FontWeight="SemiBold" Margin="10,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <TextBlock Text="{Binding TotalCost, StringFormat=C2}" Foreground="White" FontSize="24" FontWeight="Bold" HorizontalAlignment="Right"/>
                    </StackPanel>
                </materialDesign:Card>

                <materialDesign:Card Grid.Column="2" Margin="10,0,0,0" Padding="15" UniformCornerRadius="8" Background="#2196F3">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <materialDesign:PackIcon Kind="ChartLine" Width="24" Height="24" Foreground="White" VerticalAlignment="Center"/>
                            <TextBlock Text="总毛利 (结余)" Foreground="White" FontSize="16" FontWeight="SemiBold" Margin="10,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        <TextBlock Text="{Binding TotalGrossProfit, StringFormat=C2}" Foreground="White" FontSize="24" FontWeight="Bold" HorizontalAlignment="Right"/>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>

            <materialDesign:Card Margin="0,0,0,10" UniformCornerRadius="8">
                <Expander Header="收支趋势分析图表" 
                          IsExpanded="{Binding IsChartExpanded, Mode=TwoWay}" 
                          Background="White" Padding="10">
                    <Grid Height="200">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <lvc:CartesianChart Grid.Row="1" Series="{Binding ChartSeries}" LegendLocation="Right">
                            <lvc:CartesianChart.AxisX>
                                <lvc:Axis Title="月份" Labels="{Binding ChartLabels}" Separator="{x:Static lvc:DefaultAxes.CleanSeparator}"/>
                            </lvc:CartesianChart.AxisX>
                            <lvc:CartesianChart.AxisY>
                                <lvc:Axis Title="金额" LabelFormatter="{Binding YFormatter}"/>
                            </lvc:CartesianChart.AxisY>
                            <lvc:CartesianChart.DataTooltip>
                                <lvc:DefaultTooltip SelectionMode="SharedYValues" ShowTitle="True"/>
                            </lvc:CartesianChart.DataTooltip>
                        </lvc:CartesianChart>
                    </Grid>
                </Expander>
            </materialDesign:Card>

            <materialDesign:Card Margin="0,0,0,10" Padding="15" UniformCornerRadius="8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <materialDesign:PackIcon Kind="CalendarRange" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="Gray"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Width="100" materialDesign:HintAssist.Hint="开始日期" VerticalAlignment="Center"/>
                        <TextBlock Text=" - " VerticalAlignment="Center" Margin="5,0"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Width="100" materialDesign:HintAssist.Hint="结束日期" VerticalAlignment="Center"/>

                        <materialDesign:PackIcon Kind="Magnify" VerticalAlignment="Center" Foreground="Gray" Margin="20,0,5,0"/>
                        <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                 materialDesign:HintAssist.Hint="筛选单品名称..."
                                 Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                                 Width="150" VerticalAlignment="Center" Margin="0,-10,0,0"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="查询/刷新" Command="{Binding RefreshDataCommand}" Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,15,0"/>
                        <Button Command="{Binding ExportCommand}" Style="{StaticResource MaterialDesignOutlinedButton}" Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="FileExcel" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                <TextBlock Text="导出Excel" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Button Content="打印报表" Command="{Binding PrintCommand}" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>

            <materialDesign:Card Padding="0" UniformCornerRadius="8">
                <TabControl SelectedIndex="{Binding SelectedTabIndex}" Margin="5">
                    <TabItem Header="单品利润分析" FontSize="16">
                        <DataGrid ItemsSource="{Binding FinancialList}" 
                                  PreviewMouseWheel="MainDataGrid_PreviewMouseWheel"
                                  AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True"
                                  HeadersVisibility="All" SelectionMode="Single"
                                  VerticalScrollBarVisibility="Disabled"
                                  MinHeight="100"
                                  Style="{StaticResource MaterialDesignDataGrid}">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="产品名称" Binding="{Binding ProductName}" Width="2*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Left" />
                                            <Setter Property="Padding" Value="10,0,0,0"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="采购总成本" Binding="{Binding TotalCost, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}"/>
                                <DataGridTextColumn Header="销售总收入" Binding="{Binding TotalRevenue, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}"/>
                                <DataGridTextColumn Header="销售利润" Binding="{Binding SalesProfit, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="#FF9800" FontWeight="SemiBold"/>
                                <DataGridTextColumn Header="退款总额" Binding="{Binding TotalRefund, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}"/>
                                <DataGridTextColumn Header="毛利润" Binding="{Binding GrossProfit, StringFormat=C2}" Width="1*" FontWeight="Bold">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                            <Setter Property="VerticalAlignment" Value="Center" />
                                            <Setter Property="Foreground" Value="#3F51B5"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="月度报表" FontSize="16">
                        <DataGrid ItemsSource="{Binding MonthlyList}" 
                                  PreviewMouseWheel="MainDataGrid_PreviewMouseWheel"
                                  AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True"
                                  HeadersVisibility="All" SelectionMode="Extended"
                                  RowDetailsTemplate="{StaticResource FinancialDetailsTemplate}"
                                  VerticalScrollBarVisibility="Disabled"
                                  MinHeight="100"
                                  Style="{StaticResource MaterialDesignDataGrid}">

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                                    <Setter Property="DetailsVisibility" Value="{Binding IsExpanded, Converter={StaticResource BoolToVisConverter}}"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>

                            <DataGrid.Columns>
                                <DataGridTemplateColumn Width="50">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ContentControl Content="{Binding}" ContentTemplate="{StaticResource ExpandButtonTemplate}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="月份" Binding="{Binding PeriodName}" Width="1.5*" FontWeight="Bold" ElementStyle="{StaticResource CenterText}"/>
                                <DataGridTextColumn Header="总收入" Binding="{Binding Revenue, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="#4CAF50"/>
                                <DataGridTextColumn Header="总成本" Binding="{Binding Cost, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="#F44336"/>
                                <DataGridTextColumn Header="总退款" Binding="{Binding Refund, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="Gray"/>
                                <DataGridTextColumn Header="净利润" Binding="{Binding Profit, StringFormat=C2}" Width="1*" FontWeight="Bold">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                            <Setter Property="VerticalAlignment" Value="Center" />
                                            <Setter Property="Foreground" Value="#3F51B5"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="利润率" Binding="{Binding ProfitMargin}" Width="0.8*" ElementStyle="{StaticResource CenterText}"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>

                    <TabItem Header="年度报表" FontSize="16">
                        <DataGrid ItemsSource="{Binding YearlyList}" 
                                  PreviewMouseWheel="MainDataGrid_PreviewMouseWheel"
                                  AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True"
                                  HeadersVisibility="All" SelectionMode="Extended"
                                  RowDetailsTemplate="{StaticResource FinancialDetailsTemplate}"
                                  VerticalScrollBarVisibility="Disabled"
                                  MinHeight="100"
                                  Style="{StaticResource MaterialDesignDataGrid}">

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow" BasedOn="{StaticResource MaterialDesignDataGridRow}">
                                    <Setter Property="DetailsVisibility" Value="{Binding IsExpanded, Converter={StaticResource BoolToVisConverter}}"/>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}">
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>

                            <DataGrid.Columns>
                                <DataGridTemplateColumn Width="50">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ContentControl Content="{Binding}" ContentTemplate="{StaticResource ExpandButtonTemplate}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="年份" Binding="{Binding PeriodName}" Width="1.5*" FontWeight="Bold" ElementStyle="{StaticResource CenterText}"/>
                                <DataGridTextColumn Header="总收入" Binding="{Binding Revenue, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="#4CAF50"/>
                                <DataGridTextColumn Header="总成本" Binding="{Binding Cost, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="#F44336"/>
                                <DataGridTextColumn Header="总退款" Binding="{Binding Refund, StringFormat=C2}" Width="1*" ElementStyle="{StaticResource CenterText}" Foreground="Gray"/>
                                <DataGridTextColumn Header="净利润" Binding="{Binding Profit, StringFormat=C2}" Width="1*" FontWeight="Bold">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                            <Setter Property="VerticalAlignment" Value="Center" />
                                            <Setter Property="Foreground" Value="#3F51B5"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="利润率" Binding="{Binding ProfitMargin}" Width="0.8*" ElementStyle="{StaticResource CenterText}"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>
                </TabControl>
            </materialDesign:Card>
        </StackPanel>
    </ScrollViewer>
</UserControl>